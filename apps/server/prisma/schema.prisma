generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User model for authentication
model User {
  id           String    @id @default(cuid())
  email        String    @unique
  password     String    // bcrypt hashed
  name         String
  role                String    @default("user") // user | admin
  isActive            Boolean   @default(true)
  resetToken          String?
  resetTokenExpiresAt DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Ownership
  folders      Folder[]
  environments Environment[]
  history      HistoryEntry[]

  // Sharing (direct user sharing)
  sharedFolders      FolderShare[]      @relation("SharedWithUser")
  sharedEnvironments EnvironmentShare[] @relation("SharedWithUser")

  // Group membership
  groupMemberships   GroupMember[]

  @@index([email])
}

// Group for team collaboration
model Group {
  id          String   @id @default(cuid())
  name        String
  description String   @default("")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Members
  members     GroupMember[]

  // Owned resources
  folders     Folder[]
  environments Environment[]

  @@index([name])
}

// Group membership (users belong to groups)
model GroupMember {
  id        String   @id @default(cuid())
  groupId   String
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String   @default("member") // member | admin | owner
  createdAt DateTime @default(now())

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
}

// Folder sharing
model FolderShare {
  id         String   @id @default(cuid())
  folderId   String
  folder     Folder   @relation(fields: [folderId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation("SharedWithUser", fields: [userId], references: [id], onDelete: Cascade)
  permission String   @default("read") // read | write | admin
  createdAt  DateTime @default(now())

  @@unique([folderId, userId])
  @@index([folderId])
  @@index([userId])
}

// Environment sharing
model EnvironmentShare {
  id            String      @id @default(cuid())
  environmentId String
  environment   Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)
  userId        String
  user          User        @relation("SharedWithUser", fields: [userId], references: [id], onDelete: Cascade)
  permission    String      @default("read") // read | write | admin
  createdAt     DateTime    @default(now())

  @@unique([environmentId, userId])
  @@index([environmentId])
  @@index([userId])
}

model Folder {
  id          String    @id @default(cuid())
  name        String
  description String    @default("")
  parentId    String?
  parent      Folder?   @relation("FolderChildren", fields: [parentId], references: [id], onDelete: Cascade)
  children    Folder[]  @relation("FolderChildren")
  requests    Request[]

  // Inheritable settings
  headers         String  @default("[]") // JSON array of KeyValueItem
  queryParams     String  @default("[]") // JSON array of KeyValueItem
  authType        String  @default("inherit")
  authConfig      String  @default("{}") // JSON object
  preScript       String?
  postScript      String?
  baseUrl         String?

  // Network settings
  timeout         Int?
  followRedirects String  @default("inherit") // inherit | true | false
  verifySsl       String  @default("inherit") // inherit | true | false
  proxy           String?

  // Ownership (either user OR group, not both)
  userId      String?
  owner       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  groupId     String?
  group       Group?   @relation(fields: [groupId], references: [id], onDelete: SetNull)
  shares      FolderShare[]

  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([parentId])
  @@index([userId])
  @@index([groupId])
}

model Request {
  id              String   @id @default(cuid())
  name            String
  description     String   @default("")
  method          String   @default("GET")
  url             String   @default("")
  queryParams     String   @default("[]") // JSON array of KeyValueItem
  headers         String   @default("[]") // JSON array of KeyValueItem
  bodyType        String   @default("none")
  body            String   @default("")
  bodyDescription String   @default("")
  authType        String   @default("inherit")
  authConfig      String   @default("{}") // JSON object
  preScript       String?
  postScript      String?

  // Network settings
  timeout         Int?
  followRedirects String   @default("inherit")
  verifySsl       String   @default("inherit")
  proxy           String?

  folderId  String
  folder    Folder   @relation(fields: [folderId], references: [id], onDelete: Cascade)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([folderId])
}

model Environment {
  id          String                @id @default(cuid())
  name        String
  description String                @default("")
  isActive    Boolean               @default(false)
  variables   EnvironmentVariable[]

  // Ownership (either user OR group, not both)
  userId      String?
  owner       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  groupId     String?
  group       Group?   @relation(fields: [groupId], references: [id], onDelete: SetNull)
  shares      EnvironmentShare[]

  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  @@index([userId])
  @@index([groupId])
}

model EnvironmentVariable {
  id            String      @id @default(cuid())
  key           String
  value         String      @default("")
  description   String      @default("")
  type          String      @default("string") // string | secret | dynamic
  scope         String      @default("global") // global | collection | request | local
  isSecret      Boolean     @default(false)
  category      String      @default("input") // input | generated
  sortOrder     Int         @default(0)
  environmentId String
  environment   Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)

  @@unique([environmentId, key, scope])
  @@index([environmentId])
}

model LocalOverride {
  id            String   @id @default(cuid())
  key           String
  value         String
  description   String   @default("")
  environmentId String
  userId        String   @default("local")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([environmentId, key, userId])
  @@index([environmentId])
}

model HistoryEntry {
  id              String   @id @default(cuid())
  method          String
  url             String
  requestHeaders  String   // JSON object
  requestBody     String?
  responseStatus  Int
  responseHeaders String   // JSON object
  responseBody    String?
  responseTime    Int      // ms
  responseSize    Int      // bytes

  // Ownership
  userId          String?
  owner           User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt       DateTime @default(now())

  @@index([createdAt])
  @@index([userId])
}

model Settings {
  id        String   @id @default("default")
  data      String   @default("{}") // JSON object with AppSettings
  updatedAt DateTime @updatedAt
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String   // user.created, user.deactivated, user.role_changed, group.created, etc.
  userId    String?  // who performed the action (null for system)
  targetId  String?  // what was affected
  details   String   @default("{}") // JSON with extra info
  createdAt DateTime @default(now())

  @@index([action])
  @@index([userId])
  @@index([createdAt])
}
